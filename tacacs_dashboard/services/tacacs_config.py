# tacacs_dashboard/services/tacacs_config.py
from __future__ import annotations

from pathlib import Path
import re

from .policy_store import load_policy
from .user_secrets_store import get_user_password, ensure_user_has_password
from .privilege import parse_privilege

# โฟลเดอร์ฐานของโปรเจกต์ (ที่มี policy.json, secret.env, pass.secret)
BASE_DIR = Path(__file__).resolve().parent.parent.parent
SECRET_ENV_PATH = BASE_DIR / "secret.env"
PASS_SECRET_PATH = BASE_DIR / "pass.secret"

LOG_DIR = Path("/var/log/tac_plus")


def _read_env(key: str, default: str = "") -> str:
    if not SECRET_ENV_PATH.exists():
        return default
    for line in SECRET_ENV_PATH.read_text(encoding="utf-8").splitlines():
        line = line.strip()
        if not line or line.startswith("#"):
            continue
        if line.startswith(key + "="):
            return line.split("=", 1)[1].strip()
    return default


def load_shared_key() -> str:
    return _read_env("TACACS_SHARED_KEY", "CHANGE_ME") or "CHANGE_ME"


def load_default_user_password() -> str:
    return _read_env("DEFAULT_USER_PASSWORD", "test") or "test"


def load_enable15_password() -> str:
    """
    enable password (ระดับ 15) ที่ OLT จะถามตอนพิมพ์ enable
    ตั้งไว้ใน secret.env เช่น:
      OLT_ENABLE15_PASSWORD=zxr10
    """
    return _read_env("OLT_ENABLE15_PASSWORD", "")


def _escape(s: str) -> str:
    return (s or "").replace("\\", "\\\\").replace('"', '\\"')


def _parse_privilege(value) -> int:
    """
    role.privilege ใน policy อาจเป็น '15 / full' หรือ '7' หรือ 7
    """
    # ✅ normalize + clamp 1..15
    return parse_privilege(value, default=1)


def _user_profile_lines(role_name: str, priv: int) -> list[str]:
    """
    สร้าง profile.script ใน user (pass.secret) เพื่อคุมสิทธิ์
    - VIEW: allow show/exit/logout/quit เท่านั้น
    - ENGINEER: deny conf/config/configure (รวม conf t) แต่คำสั่งอื่น permit
    - ADMIN: permit all
    """
    role = (role_name or "OLT_VIEW").strip()
    p = max(1, min(15, int(priv)))

    lines: list[str] = []
    lines.append("  profile {")
    lines.append(f"    enable {p} = login")
    lines.append("    script {")
    lines.append("      if (service == shell) {")
    lines.append('        if (cmd == "") {')
    lines.append(f"          set priv-lvl = {p}")
    lines.append("          permit")
    lines.append("        }")

    if role == "OLT_VIEW":
        # อนุญาต show ... และ exit/logout/quit เท่านั้น
        lines.append(r"        if (cmd =~ /^show(\s|$)/) permit")
        lines.append(r"        if (cmd =~ /^(exit|logout|quit)(\s|$)/) permit")
        lines.append("        deny")

    elif role == "OLT_ENGINEER":
        # (optional) กันคำสั่งอันตรายจาก TACACS อีกชั้น
        lines.append(r"        if (cmd =~ /^reload(\s|$)/) deny")
        lines.append(r"        if (cmd =~ /^reload-/) deny")
        lines.append(r"        if (cmd =~ /^power(\s|$)/) deny")
        lines.append(r"        if (cmd =~ /^power-/) deny")
        lines.append(r"        if (cmd =~ /^ping(\s|$)/) deny")
        lines.append("        permit")

    else:
        # OLT_ADMIN หรือ role อื่น ๆ
        lines.append("        permit")

    lines.append("      }")
    lines.append("      permit")
    lines.append("    }")
    lines.append("  }")
    return lines


def build_pass_secret_text() -> str:
    """
    สร้าง pass.secret จาก policy.users
    - ใส่ member = <ROLE>
    - ใส่ profile script ต่อ user (เพราะ group ใส่ profile ไม่ได้)
    """
    policy = load_policy()
    users = policy.get("users", [])
    roles = policy.get("roles", [])

    default_pw = load_default_user_password()
    role_priv = {(r.get("name") or "").strip(): _parse_privilege(r.get("privilege")) for r in roles}

    lines: list[str] = []
    lines.append("# Auto-generated by NT TACACS+ Dashboard")
    lines.append("# ห้ามแก้ไฟล์นี้ตรง ๆ (จะแทนที่ทุกครั้งที่ generate จาก web)")
    lines.append("")

    for u in users:
        username = (u.get("username") or u.get("name") or "").strip()
        if not username:
            continue

        status = (u.get("status") or "Active").strip().lower()
        if status not in ("active", "enable", "enabled"):
            continue

        role = (
            u.get("roles")
            or u.get("role")
            or u.get("group")
            or u.get("role_name")
            or u.get("roleName")
            or "OLT_VIEW"
        )
        role = str(role).strip() or "OLT_VIEW"

        priv = role_priv.get(role, 1)

        # ✅ ensure มี entry ใน user_secrets.json (ถ้ายังไม่มีก็ใส่ default ให้)
        ensure_user_has_password(username)

        # ✅ password ของ user (ถ้าไม่มีราย user จะ fallback ไป default_password)
        pw = get_user_password(username)

        lines.append(f"user {username} {{")
        lines.append(f'  password login = clear "{_escape(pw)}"')
        lines.append("  password pap = login")
        lines.append(f"  member = {role}")
        lines.append("")
        lines.extend(_user_profile_lines(role, priv))
        lines.append("}")
        lines.append("")

    return "\n".join(lines)


def build_config_text() -> str:
    """สร้าง tacacs-generated.cfg"""
    policy = load_policy()
    roles = policy.get("roles", [])
    devices = policy.get("devices", [])

    shared_key = load_shared_key()
    enable15 = load_enable15_password()

    lines: list[str] = []
    lines.append("# Auto-generated by NT TACACS+ Dashboard")
    lines.append("# ห้ามแก้ไฟล์นี้ตรง ๆ (จะแทนที่ทุกครั้งที่ generate จาก web)")
    lines.append("")

    # spawnd
    lines.append("id = spawnd {")
    lines.append("  listen = {")
    lines.append("    port = 49")
    lines.append("  }")
    lines.append("}")
    lines.append("")

    # tac_plus-ng
    lines.append("id = tac_plus-ng {")
    lines.append("  # ----- Logging (authc/authz/acct/conn) -----")
    lines.append(f"  log authclog {{ destination = {LOG_DIR}/authc-%Y-%m-%d.log }}")
    lines.append(f"  log authzlog {{ destination = {LOG_DIR}/authz-%Y-%m-%d.log }}")
    lines.append(f"  log acctlog  {{ destination = {LOG_DIR}/acct-%Y-%m-%d.log }}")
    lines.append(f"  log connlog  {{ destination = {LOG_DIR}/conn-%Y-%m-%d.log }}")
    lines.append("")
    lines.append("  authentication log = authclog")
    lines.append("  authorization log = authzlog")
    lines.append("  accounting log = acctlog")
    lines.append("  connection log = connlog")
    lines.append("")

    # Devices -> host
    lines.append("  # ----- Devices (policy.devices -> host) -----")
    for dev in devices:
        name = dev.get("name") or dev.get("id") or "OLT_UNKNOWN"
        addr = dev.get("address") or dev.get("ip") or "0.0.0.0"
        lines.append(f"  host = {name} {{")
        lines.append(f"    address = {addr}")
        lines.append(f'    key = "{_escape(shared_key)}"')
        if enable15:
            lines.append(f'    enable 15 = clear "{_escape(enable15)}"')
        lines.append("  }")
        lines.append("")

    # Roles -> group (ห้ามใส่ profile ใน group)
    lines.append("  # ----- Roles (as groups) -----")
    for r in roles:
        name = (r.get("name") or "ROLE_NO_NAME").strip()
        if not name:
            continue
        lines.append(f"  group = {name} {{")
        lines.append("  }")
        lines.append("")

    # include pass.secret
    lines.append("  # Users are defined in separate pass.secret file")
    lines.append(f'  include = "{PASS_SECRET_PATH}"')
    lines.append("}")

    return "\n".join(lines)


