from pathlib import Path
from .policy_store import load_policy

# ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå (‡∏ó‡∏µ‡πà‡∏°‡∏µ policy.json, secret.env, pass.secret)
BASE_DIR = Path(__file__).resolve().parent.parent.parent
SECRET_ENV_PATH = BASE_DIR / "secret.env"

# üëâ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ (‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Å‡πá‡∏ö user/password ‡∏Ç‡∏≠‡∏á TACACS+)
PASS_SECRET_PATH = BASE_DIR / "pass.secret"


def load_shared_key() -> str:
    """
    ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ TACACS_SHARED_KEY ‡∏à‡∏≤‡∏Å secret.env
    ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ CHANGE_ME ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    """
    if not SECRET_ENV_PATH.exists():
        return "CHANGE_ME"

    for line in SECRET_ENV_PATH.read_text(encoding="utf-8").splitlines():
        line = line.strip()
        if not line or line.startswith("#"):
            continue
        if line.startswith("TACACS_SHARED_KEY="):
            return line.split("=", 1)[1].strip()

    return "CHANGE_ME"


def build_config_text() -> str:
    policy = load_policy()
    users   = policy.get("users", [])
    roles   = policy.get("roles", [])
    devices = policy.get("devices", [])

    shared_key = load_shared_key()

    lines: list[str] = []

    lines.append("# Auto-generated by NT TACACS+ Dashboard")
    lines.append("# ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏ï‡∏£‡∏á ‡πÜ (‡∏à‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà generate ‡∏à‡∏≤‡∏Å web)")
    lines.append("")

    # ---------- spawnd ----------
    lines.append("id = spawnd {")
    lines.append("  listen = {")
    lines.append("    port = 49")
    lines.append("  }")
    lines.append("}")
    lines.append("")

    # ---------- tac_plus-ng ----------
    lines.append("id = tac_plus-ng {")
    # üëâ ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: include ‡πÑ‡∏ü‡∏•‡πå pass.secret ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö user/password ‡∏à‡∏£‡∏¥‡∏á
    lines.append(f'  include = "{PASS_SECRET_PATH}"')
    lines.append("")

    lines.append("  # Devices (map ‡∏à‡∏≤‡∏Å policy.devices -> host)")
    for dev in devices:
        name = dev.get("name") or dev.get("id") or "OLT_UNKNOWN"
        addr = dev.get("address") or dev.get("ip") or "0.0.0.0"
        lines.append(f"  host = {name} {{")
        lines.append(f"    address = {addr}")
        # ‡πÉ‡∏ä‡πâ shared_key ‡∏à‡∏≤‡∏Å secret.env (‡πÉ‡∏™‡πà‡πÉ‡∏ô "" ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡πÄ‡∏®‡∏©)
        lines.append(f'    key = "{shared_key}"')
        lines.append("  }")
        lines.append("")

    lines.append("  # Roles (as groups)")
    for r in roles:
        name = r.get("name") or "ROLE_NO_NAME"
        desc = r.get("description") or ""
        priv = r.get("privilege") or ""
        lines.append(f"  group = {name} {{")
        if priv:
            lines.append(f"    # privilege: {priv}")
        if desc:
            lines.append(f"    # description: {desc}")
        lines.append("  }")
        lines.append("")

    lines.append("  # Users (‡πÑ‡∏°‡πà‡∏°‡∏µ password ‡∏à‡∏£‡∏¥‡∏á ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô pass.secret ‡πÅ‡∏ó‡∏ô)")
    for u in users:
        username = u.get("username") or "user_unknown"
        role     = u.get("role") or u.get("roles") or ""
        lines.append(f"  user = {username} {{")
        lines.append("    # login = clear <‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ô pass.secret ‡∏´‡∏£‡∏∑‡∏≠ backend ‡∏≠‡∏∑‡πà‡∏ô>")
        if role:
            lines.append(f"    member = {role}")
        lines.append("  }")
        lines.append("")

    lines.append("}")
    lines.append("")

    return "\n".join(lines)

