# tacacs_dashboard/services/tacacs_config.py
from pathlib import Path
import re
from .policy_store import load_policy

BASE_DIR = Path(__file__).resolve().parent.parent.parent
SECRET_ENV_PATH = BASE_DIR / "secret.env"
PASS_SECRET_PATH = BASE_DIR / "pass.secret"


def load_shared_key() -> str:
    if not SECRET_ENV_PATH.exists():
        return "CHANGE_ME"
    for line in SECRET_ENV_PATH.read_text(encoding="utf-8").splitlines():
        line = line.strip()
        if not line or line.startswith("#"):
            continue
        if line.startswith("TACACS_SHARED_KEY="):
            return line.split("=", 1)[1].strip()
    return "CHANGE_ME"


def _parse_privilege(priv) -> int:
    """
    policy อาจเก็บเป็น "15", 15, หรือ "15 / full"
    """
    if priv is None:
        return 0
    if isinstance(priv, int):
        return priv
    s = str(priv).strip()
    m = re.search(r"\d+", s)
    return int(m.group(0)) if m else 0


def build_pass_secret_text(policy: dict) -> str:
    """
    auto-generate pass.secret จาก policy["users"]
    ต้องมี field password ใน policy (หรือคุณจะกำหนด default ก็ได้)
    """
    users = policy.get("users", [])
    lines: list[str] = []
    lines.append("# Auto-generated by NT TACACS+ Dashboard")
    lines.append("# ห้ามแก้ไฟล์นี้ตรง ๆ (จะแทนที่ทุกครั้งที่ generate จาก web)")
    lines.append("")

    for u in users:
        status = (u.get("status") or "Active").lower()
        if status != "active":
            continue

        username = u.get("username") or u.get("name")
        if not username:
            continue

        role = u.get("role") or u.get("group")  # ex: OLT_ENGINEER
        password = u.get("password")  # << สำคัญ: ให้ UI เก็บ field นี้ด้วย

        if not password:
            # จะเลือก skip หรือใส่ placeholder ก็ได้
            # continue
            password = "CHANGE_ME"

        lines.append(f"user {username} {{")
        lines.append(f'  password login = clear "{password}"')
        lines.append("  password pap = login")     # สำคัญสำหรับ ZTE/PAP
        if role:
            lines.append(f"  member = {role}")     # ผูกกับ group จาก roles
        lines.append("}")
        lines.append("")

    return "\n".join(lines)


def build_config_text() -> str:
    policy = load_policy()
    roles   = policy.get("roles", [])
    devices = policy.get("devices", [])

    shared_key = load_shared_key()
    lines: list[str] = []

    lines.append("# Auto-generated by NT TACACS+ Dashboard")
    lines.append("# ห้ามแก้ไฟล์นี้ตรง ๆ (จะแทนที่ทุกครั้งที่ generate จาก web)")
    lines.append("")

    # ---------- spawnd ----------
    lines.append("id = spawnd {")
    lines.append("  listen = {")
    lines.append("    port = 49")
    lines.append("  }")
    lines.append("}")
    lines.append("")

    # ---------- tac_plus-ng ----------
    lines.append("id = tac_plus-ng {")
    lines.append("  # Devices (map จาก policy.devices -> host)")
    for dev in devices:
        name = dev.get("name") or dev.get("id") or "OLT_UNKNOWN"
        addr = dev.get("address") or dev.get("ip") or "0.0.0.0"
        lines.append(f"  host = {name} {{")
        lines.append(f"    address = {addr}")
        lines.append(f'    key = "{shared_key}"')
        lines.append("  }")
        lines.append("")

    # Roles -> group + profile(script) set priv-lvl
    lines.append("  # Roles (as groups)")
    for r in roles:
        name = r.get("name") or "ROLE_NO_NAME"
        desc = r.get("description") or ""
        priv = r.get("privilege") or ""
        lines.append(f"  group = {name} {{")
        if priv:
            lines.append(f"    # privilege: {priv}")
        if desc:
            lines.append(f"    # description: {desc}")
        lines.append("  }")
        lines.append("")

    # ให้ config include pass.secret (ที่เราจะ auto-generate)
    lines.append("  # Users are defined in separate pass.secret file")
    lines.append(f'  include = "{PASS_SECRET_PATH}"')
    lines.append("}")

    return "\n".join(lines)

def load_default_user_password() -> str:
    """
    อ่าน DEFAULT_USER_PASSWORD จาก secret.env (ถ้าไม่มีก็ใช้ 'test')
    """
    if not SECRET_ENV_PATH.exists():
        return "test"

    for line in SECRET_ENV_PATH.read_text(encoding="utf-8").splitlines():
        line = line.strip()
        if not line or line.startswith("#"):
            continue
        if line.startswith("DEFAULT_USER_PASSWORD="):
            return line.split("=", 1)[1].strip() or "test"
    return "test"


def _escape(s: str) -> str:
    # ป้องกัน quote พังไฟล์
    return (s or "").replace("\\", "\\\\").replace('"', '\\"')


def _parse_privilege(value) -> int:
    """
    role.privilege ในเว็บอาจเป็น '15' หรือ '15 / full' -> เอาเลขตัวแรก
    """
    if value is None:
        return 1
    m = re.search(r"\d+", str(value))
    return int(m.group(0)) if m else 1


def build_pass_secret_text() -> str:
    policy = load_policy()
    users = policy.get("users", [])
    roles = policy.get("roles", [])

    role_priv = {r.get("name"): _parse_privilege(r.get("privilege")) for r in roles}
    default_pw = load_default_user_password()

    lines: list[str] = []
    lines.append("# Auto-generated by NT TACACS+ Dashboard")
    lines.append("# ห้ามแก้ไฟล์นี้ตรง ๆ (จะแทนที่ทุกครั้งที่ generate จาก web)")
    lines.append("")

    for u in users:
        username = (u.get("username") or u.get("name") or "").strip()
        if not username:
            continue

        status = (u.get("status") or "Active").strip().lower()
        if status not in ("active", "enable", "enabled"):
            # ข้าม user ที่ disabled
            continue

        role = (u.get("role") or u.get("group") or "OLT_VIEW").strip()
        priv = role_priv.get(role, 1)

        # ถ้าในอนาคตคุณเพิ่ม password ต่อ user ใน policy ก็รองรับไว้:
        pw = u.get("password") or default_pw

        lines.append(f"user {username} {{")
        lines.append(f'  password login = clear "{_escape(pw)}"')
        lines.append("  password pap = login")
        lines.append(f"  member = {role}")
        lines.append("")
        lines.append("  profile {")
        lines.append("    script {")
        lines.append("      if (service == shell) {")
        lines.append('        if (cmd == "") {')
        lines.append(f"          set priv-lvl = {priv}")
        lines.append("          permit")
        lines.append("        }")
        lines.append("        permit")
        lines.append("      }")
        lines.append("      permit")
        lines.append("    }")
        lines.append("  }")
        lines.append("}")
        lines.append("")

    return "\n".join(lines)
