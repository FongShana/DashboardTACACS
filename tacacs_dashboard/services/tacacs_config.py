from .policy_store import load_policy

def build_config_text() -> str:
    policy = load_policy()
    users   = policy.get("users", [])
    roles   = policy.get("roles", [])
    devices = policy.get("devices", [])

    lines: list[str] = []

    lines.append("# Auto-generated by NT TACACS+ Dashboard")
    lines.append("# ห้ามแก้ไฟล์นี้ตรง ๆ (จะแทนที่ทุกครั้งที่ generate จาก web)")
    lines.append("")

    # --- spawnd (ตัวแม่) ---
    lines.append("id = spawnd {")
    lines.append("  listen = {")
    lines.append("    port = 49")
    lines.append("  }")
    lines.append("}")
    lines.append("")

    # --- tac_plus (ตัว TACACS+ จริง) ---
    lines.append("id = tac_plus-ng {")
    lines.append("  # Devices (map จาก policy.devices -> host)")
    for dev in devices:
        name = dev.get("name") or dev.get("id") or "OLT_UNKNOWN"
        addr = dev.get("address") or dev.get("ip") or "0.0.0.0"
        lines.append(f"  host = {name} {{")
        lines.append(f"    address = {addr}")
        lines.append("    key = SECRETKEY   # TODO: แยก secret จริงออกไปเก็บที่อื่น")
        lines.append("  }")
        lines.append("")

    lines.append("  # Roles (map เป็น group เฉย ๆ ยังไม่ได้ใส่ rule ลึก ๆ)")
    for r in roles:
        name = r.get("name") or "ROLE_NO_NAME"
        desc = r.get("description") or ""
        priv = r.get("privilege") or ""
        lines.append(f"  group = {name} {{")
        if priv:
            lines.append(f"    # privilege: {priv}")
        if desc:
            lines.append(f"    # description: {desc}")
        lines.append("  }")
        lines.append("")

    lines.append("  # Users (map จาก policy.users)")
    for u in users:
        username = u.get("username") or "user_unknown"
        role     = u.get("role") or u.get("roles") or ""
        lines.append(f"  user = {username} {{")
        lines.append("    # login = clear <ใส่รหัสจริงในไฟล์ include แยก หรือ backend อื่น>")
        if role:
            lines.append(f"    member = {role}")
        lines.append("  }")
        lines.append("")

    lines.append("}")  # จบ id = tac_plus

    return "\n".join(lines) + "\n"

