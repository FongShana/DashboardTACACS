{% extends "base.html" %}

{% block title %}Devices / OLT | NT TACACS+{% endblock %}
{% block header %}Devices / OLT{% endblock %}

{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  <div class="flash-container">
    {% for category, message in messages %}
      <div class="flash flash-{{ category }}">{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %}
{% endwith %}

<h2 class="mb-3">Add Device / OLT</h2>
<form method="post" action="{{ url_for('devices.create_device_form') }}" class="form-card">
  <div class="form-grid">
    <div class="form-row">
      <label for="dev_name">Name</label>
      <input class="input" id="dev_name" type="text" name="name"
             placeholder="เช่น OLT_ZTE_BTG1" required>
    </div>

    <div class="form-row">
      <label for="dev_vendor">Vendor</label>
      <input class="input" id="dev_vendor" type="text" name="vendor"
             placeholder="ZTE / Huawei / ฯลฯ">
    </div>

    <div class="form-row">
      <label for="dev_ip">IP Address</label>
      <input class="input" id="dev_ip" type="text" name="ip" placeholder="10.x.x.x" required>
    </div>

    <div class="form-row">
      <label for="dev_site">Site</label>
      <input class="input" id="dev_site" type="text" name="site"
             placeholder="BTG / SITE-A / LAB ฯลฯ">
    </div>

    <div class="form-row">
      <label for="dev_group">Device Group</label>
      <select class="input" id="dev_group" name="group_id" {% if is_scoped_admin %}required{% endif %}>
        {% if not is_scoped_admin %}
          <option value="">(none)</option>
        {% endif %}
        {% for g in device_groups %}
          <option value="{{ g.id if g.id is defined else g['id'] }}">
            {{ g.name if g.name is defined else g.get('name','') }} ({{ g.id if g.id is defined else g['id'] }})
          </option>
        {% endfor %}
      </select>
      {% if is_scoped_admin and (device_groups|length) == 0 %}
        <div class="hint">บัญชี admin นี้ยังไม่ได้ถูกกำหนด Device Group — กรุณาให้ superadmin กำหนดก่อน</div>
      {% endif %}
    </div>

    <div class="form-row">
      <label for="dev_status">Status</label>
      <select class="input" id="dev_status" name="status">
        <option value="Online">Online</option>
        <option value="Offline">Offline</option>
        <option value="Unknown" selected>Unknown</option>
      </select>
    </div>
  </div>

  <div class="hint" style="margin-top: 10px;">
    Add Device จะเพิ่มลง <code>policy.json</code> เท่านั้น
    — การยิงคำสั่งไปที่ OLT ให้กดปุ่ม <b>Bootstrap AAA</b> ในตารางด้านล่าง
  </div>

  <button type="submit" class="btn btn-primary">Add Device</button>
</form>

<section class="section">
  <h2 class="section-title">Generate &amp; Apply TACACS+ Config</h2>

  <form method="post" action="{{ url_for('devices.generate_config_submit') }}" style="margin-top:0.75rem;">
    <button type="submit" class="btn btn-primary" onclick="return confirm('Generate config + syntax check + restart tac_plus-ng ?')">
      Generate &amp; Check
    </button>
  </form>
</section>

<section class="section">
  <h2 class="section-title">Registered Devices / OLT</h2>
  <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Vendor</th>
          <th>IP</th>
          <th>Site</th>
          <th>Group</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for d in devices %}
        <tr>
          <td>{{ d.name }}</td>
          <td>{{ d.vendor }}</td>
          <td>{{ d.ip }}</td>
          <td>{{ d.site }}</td>
          <td>{{ d.group_name if d.group_name is defined else '-' }}</td>
          <td>{{ d.status }}</td>
          <td class="actions">
            <a href="{{ url_for('devices.edit_device_form', name=d.name) }}"
               class="btn btn-secondary btn-sm">
              Edit
            </a>
            <form method="post"
                  action="{{ url_for('devices.bootstrap_device_submit', name=d.name) }}"
                  style="display:inline;">
              <label class="inline-check">
                <input type="checkbox" name="save" value="1">
                <span>write</span>
              </label>
              <button type="submit" name="dry_run" value="1"
                      class="btn btn-secondary btn-sm"
                      onclick="return confirm('Preview bootstrap (no changes) บน {{ d.name }} ?')">
                Preview
              </button>
              <button type="submit" class="btn btn-primary btn-sm"
                      onclick="return confirm('Bootstrap AAA templates (2128) + bind template (128) บน {{ d.name }} ?')">
                Bootstrap AAA
              </button>
            </form>
            <form method="post"
                  action="{{ url_for('devices.delete_device_form', name=d.name) }}"
                  style="display:inline;">
              <button type="submit" class="btn btn-danger btn-sm"
                      onclick="return confirm('ลบอุปกรณ์ {{ d.name }} ?')">
                Delete
              </button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7">ยังไม่มีอุปกรณ์ในระบบ</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

{% endblock %}




