{% extends "base.html" %}

{% block title %}Logs & Audit | NT TACACS+{% endblock %}
{% block header %}Logs &amp; Audit{% endblock %}

{% block content %}

<section class="section">
  <h2 class="section-title">Summary</h2>
  <div class="card-grid">
    <div class="card">
      <div class="card-label">Auth Events</div>
      <div class="card-value">{{ total_events }}</div>
      <div class="card-sub">จำนวนเหตุการณ์ Authentication (ตาม filter ปัจจุบัน)</div>
    </div>
    <div class="card">
      <div class="card-label">Command Logs</div>
      <div class="card-value">{{ total_cmd }}</div>
      <div class="card-sub">คำสั่งที่ถูกส่งไปยัง OLT (จาก log parser)</div>
    </div>
    <div class="card">
      <div class="card-label">Success</div>
      <div class="card-value">{{ total_success }}</div>
      <div class="card-sub">ACCEPT / PASS</div>
    </div>
    <div class="card">
      <div class="card-label">Failed</div>
      <div class="card-value">{{ total_fail }}</div>
      <div class="card-sub">REJECT / FAIL</div>
    </div>
    <div class="card">
      <div class="card-label">Users</div>
      <div class="card-value">{{ unique_user_count }}</div>
      <div class="card-sub">ผู้ใช้ที่มีเหตุการณ์ในช่วงนี้</div>
    </div>
    <div class="card">
      <div class="card-label">Devices</div>
      <div class="card-value">{{ unique_device_count }}</div>
      <div class="card-sub">OLT / Device ที่มีการเข้าถึง</div>
    </div>
  </div>
</section>

<section class="section">
  <h2 class="section-title">All Logs</h2>

  <!-- Filter bar -->
  <form method="get" class="filter-bar">
    <!-- preserve command filters -->
    <input type="hidden" name="cmd_user" value="{{ cmd_user_filter }}">
    <input type="hidden" name="cmd_device" value="{{ cmd_device_filter }}">
    <input type="hidden" name="cmd_contains" value="{{ cmd_contains_filter }}">

    <div class="filter-item">
      <label>User</label>
      <select name="user" class="input">
        <option value="">-- All --</option>
        {% for u in user_list %}
        <option value="{{ u }}" {% if u == user_filter %}selected{% endif %}>{{ u }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="filter-item">
      <label>Device</label>
      <select name="device" class="input">
        <option value="">-- All --</option>
        {% for d in device_list %}
        <option value="{{ d }}" {% if d == device_filter %}selected{% endif %}>{{ d }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="filter-item">
      <label>Result</label>
      <select name="result" class="input">
        <option value="">-- All --</option>
        {% for r in result_list %}
        <option value="{{ r }}" {% if r == result_filter %}selected{% endif %}>{{ r }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="filter-actions">
      <button type="submit" class="btn btn-primary">Apply</button>
      <a href="{{ url_for('logs.index', cmd_user=cmd_user_filter, cmd_device=cmd_device_filter, cmd_contains=cmd_contains_filter) }}" class="btn btn-secondary">Reset</a>
    </div>
  </form>

  <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>Time</th>
          <th>User</th>
          <th>Device</th>
          <th>Action</th>
          <th>Result</th>
          <th>Raw</th>
        </tr>
      </thead>
      <tbody>
        {% for e in recent_events %}
        <tr>
          <td>{{ e.timestamp }}</td>
          <td>{{ e.user }}</td>
          <td>{{ e.device }}</td>
          <td>{{ e.action }}</td>
          <td>
            {% set res = (e.result or '') %}
            {% if res.upper() in ['ACCEPT', 'OK', 'PASS', 'SUCCESS'] %}
              <span class="badge badge-success">{{ res }}</span>
            {% elif res.upper() in ['REJECT', 'FAIL', 'ERROR'] %}
              <span class="badge badge-danger">{{ res }}</span>
            {% else %}
              <span class="badge badge-neutral">{{ res }}</span>
            {% endif %}
          </td>
          <td class="text-mono small">{{ e.raw }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6">ยังไม่มี Authentication logs ตาม filter ที่เลือก</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<section class="section">
  <h2 class="section-title">User Activity</h2>
  <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>User</th>
          <th>Auth Count</th>
        </tr>
      </thead>
      <tbody>
        {% for row in user_stats %}
        <tr>
          <td>{{ row.user }}</td>
          <td>{{ row.count }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="2">ยังไม่มีข้อมูลสถิติผู้ใช้</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<section class="section">
  <h2 class="section-title">Command Audit Logs</h2>

  <!-- Command filter bar -->
  <form method="get" class="filter-bar">
    <!-- preserve auth filters -->
    <input type="hidden" name="user" value="{{ user_filter }}">
    <input type="hidden" name="device" value="{{ device_filter }}">
    <input type="hidden" name="result" value="{{ result_filter }}">

    <div class="filter-item">
      <label>User</label>
      <select name="cmd_user" class="input">
        <option value="">-- All --</option>
        {% for u in cmd_user_list %}
        <option value="{{ u }}" {% if u == cmd_user_filter %}selected{% endif %}>{{ u }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="filter-item">
      <label>Device</label>
      <select name="cmd_device" class="input">
        <option value="">-- All --</option>
        {% for d in cmd_device_list %}
        <option value="{{ d }}" {% if d == cmd_device_filter %}selected{% endif %}>{{ d }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="filter-item" style="min-width: 280px;">
      <label>Contains</label>
      <input
        type="text"
        name="cmd_contains"
        class="input"
        value="{{ cmd_contains_filter }}"
        placeholder="เช่น gpon_olt-1/1/1 หรือ gpon_onu-1/1/1"
      />
    </div>

    <div class="filter-actions">
      <button type="submit" class="btn btn-primary">Apply</button>
      <a
        href="{{ url_for('logs.index', user=user_filter, device=device_filter, result=result_filter) }}"
        class="btn btn-secondary"
      >Clear Command Filter</a>
    </div>
  </form>

  <div class="muted" style="margin-top: 8px;">
    แสดงผลตาม filter ปัจจุบัน: <b>{{ total_cmd }}</b> รายการ | Users: <b>{{ cmd_unique_user_count }}</b> | Devices: <b>{{ cmd_unique_device_count }}</b>
    {% if scan_all_cmd %}
      | <span class="badge badge-neutral">scan all acct logs</span>
    {% endif %}
    {% if cmd_contains_filter %}
      | Keyword: <span class="badge badge-neutral">{{ cmd_contains_filter }}</span>
    {% endif %}
  </div>

  {% if cmd_user_breakdown and total_cmd > 0 %}
  <div class="card" style="margin-top: 10px;">
    <div class="card-label">Top Users (filtered commands)</div>
    <div class="small" style="margin-top: 6px;">
      {% for u, n in cmd_user_breakdown %}
        <span class="badge badge-neutral" style="margin-right: 6px;">{{ u }}: {{ n }}</span>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>Time</th>
          <th>User</th>
          <th>Device</th>
          <th>Command</th>
        </tr>
      </thead>
      <tbody>
        {% for c in command_events %}
        <tr>
          <td>{{ c.timestamp }}</td>
          <td>{{ c.user }}</td>
          <td>{{ c.device }}</td>
          <td class="text-mono small">{{ c.command }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="4">ยังไม่มี command logs (ยังไม่ได้ต่อกับ tac_plus-ng / OLT จริง)</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

{% endblock %}



